# API Документация - Giftly Service

## Общая информация

API для покупки подарков и звезд в Telegram. Все запросы требуют аутентификации через токен.

## Базовый URL
```
https://stars-rocket.com/api/v1/
```


## 1. Покупка подарка (buyGift)

### Endpoint
```
POST https://stars-rocket.com/api/v1/giftly/buyGift
```

### Описание
Добавляет запрос на покупку подарка в очередь для асинхронной обработки.

### Параметры запроса (Body)

| Поле | Тип | Обязательное | Описание |
|------|-----|--------------|----------|
| `recipient` | string | ✅ | Username получателя подарка (без @) |
| `gift_id` | string | ✅ | ID подарка для покупки |
| `token` | string | ✅ | Токен аутентификации |
| `text` | string | ❌ | Текст сообщения с подарком (опционально) |

### Пример запроса
```json
{
  "recipient": "username",
  "gift_id": "gift_123",
  "token": "your_auth_token",
  "text": "Поздравляю!"
}
```

### Успешный ответ
```json
{
  "success": true,
  "message": "Подарок успешно добавлен в очередь",
  "id": 1404
}
```

### Возможные ошибки

#### 400 Bad Request
- **Неверный токен**: `"Неверный токен, пожалуйста, обновите токен"`
- **Недостаточно средств**: `"Недостаточно денег на балансе админа для покупки подарка. Баланс: X.XX, цена подарка: Y.YY"`
- **Username не существует**: `"Username пользователя не занят"`
- **Платные сообщения**: `"У пользователя включены платные сообщения, должен написать первым"`
- **Пользователь не писал**: `"Пользователь не написал, чтобы получить подарок"`

#### 401 Unauthorized
- **Отсутствует токен**: `"Token is required"`

---

## 2. Покупка звезд (buyStars)

### Endpoint
```
POST https://stars-rocket.com/api/v1/giftly/buyStars
```

### Описание
Покупает указанное количество звезд для указанного пользователя.

### Параметры запроса (Body)

| Поле | Тип | Обязательное | Описание |
|------|-----|--------------|----------|
| `stars` | number | ✅ | Количество звезд для покупки (минимум 50) |
| `token` | string | ✅ | Токен аутентификации |
| `username` | string | ✅ | Username пользователя для покупки звезд |

### Пример запроса
```json
{
  "stars": 100,
  "token": "your_auth_token",
  "username": "username"
}
```

### Успешный ответ
```json
{
  "success": true,
  "message": "Покупка звезд успешно выполнена",
  "data": {
    "amountRub": 100.50,
    "amountTon": 0.5,
    "stars": 100,
    "username": "username",
    "recipient": "recipient_address",
    "finalText": "final_text"
  }
}
```

### Возможные ошибки

#### 400 Bad Request
- **Неверный токен**: `"Неверный токен, пожалуйста, обновите токен"`
- **Недостаточно средств**: `"Недостаточно денег на балансе админа для покупки звезд. Баланс: X.XX, цена звезд: Y.YY"`
- **Ошибка покупки**: `"Ошибка при покупке звезд"`

#### 401 Unauthorized
- **Отсутствует токен**: `"Token is required"`

---

## 3. Получение статуса подарка в очереди (getQueueItemStatus)

### Endpoint
```
GET https://stars-rocket.com/api/v1/giftly/queue/status
```

### Описание
Получение статуса подарка в очереди по его ID с проверкой токена доступа.

### Параметры запроса (Query)

| Параметр | Тип | Обязательный | Описание | Валидация |
|----------|-----|--------------|----------|-----------|
| `id` | number | ✅ | ID элемента в очереди | Положительное число |
| `token` | string | ✅ | Токен доступа | Минимум 10 символов |

### Пример запроса
```http
GET https://stars-rocket.com/api/v1/giftly/queue/status?id=123&token=user_token_abc123
```

### Успешный ответ
```json
{
  "success": true,
  "message": "Подарок в очереди, ожидает обработки",
  "status": "PENDING",
  "data": {
    "id": 123,
    "recipient": "@username",
    "gift_id": "gift_123",
    "text": "Поздравляю!",
    "token": "user_token_abc123",
    "createdAt": "2024-01-15T10:30:00.000Z",
    "updatedAt": "2024-01-15T10:35:00.000Z",
    "attempts": 2,
    "timeInQueue": {
      "hours": 1,
      "minutes": 15
    }
  }
}
```

### Возможные статусы подарка

| Статус | Описание | Сообщение |
|--------|----------|-----------|
| `PENDING` | Ожидает обработки | "Подарок в очереди, ожидает обработки" |
| `PROCESSING` | В процессе отправки | "Подарок обрабатывается" |
| `SENT` | Успешно отправлен | "Подарок успешно отправлен" |
| `FAILED` | Не удалось отправить | "Подарок не удалось отправить" |
| `EXPIRED` | Истек срок (24+ часов) | "Подарок в очереди более 24 часов, будет удален" |
| `NOT_FOUND` | Элемент не найден | "Элемент очереди не найден" |

### Возможные ошибки

#### 400 Bad Request

#### 200 OK (специальные случаи)
- **Элемент не найден**: 
```json
{
  "success": false,
  "message": "Элемент очереди не найден",
  "status": "NOT_FOUND"
}
```

- **Неверный токен для подарка**:
```json
{
  "success": false,
  "message": "Этот токен не для этого подарка",
  "status": "NOT_FOUND"
}
```

### Структура данных в ответе

```typescript
interface QueueItemStatusResponse {
  success: boolean;
  message: string;
  status: QueueItemStatus;
  data?: {
    id: number;                    // ID элемента в очереди
    recipient: string;             // Получатель подарка (@username)
    gift_id: string;              // ID подарка
    text: string;                 // Текст подарка
    token: string;                // Токен пользователя
    createdAt: string;            // Дата создания (ISO 8601)
    updatedAt: string;            // Дата последнего обновления (ISO 8601)
    attempts: number;             // Количество попыток отправки
    timeInQueue: {
      hours: number;              // Часов в очереди
      minutes: number;            // Минут в очереди
    };
  };
}
```

### Примеры использования

#### cURL
```bash
curl -X GET "https://stars-rocket.com/api/v1/giftly/queue/status?id=123&token=user_token_abc123"
```

#### JavaScript/TypeScript
```typescript
const response = await fetch('https://stars-rocket.com/api/v1/giftly/queue/status?id=123&token=user_token_abc123');
const data = await response.json();
console.log(data);
```

#### Python
```python
import requests

response = requests.get('https://stars-rocket.com/api/v1/giftly/queue/status', 
                       params={'id': 123, 'token': 'user_token_abc123'})
data = response.json()
print(data)
```

---

## Коды состояния HTTP

| Код | Описание |
|-----|----------|
| 200 | Успешный запрос |
| 400 | Ошибка в запросе (Bad Request) |
| 401 | Не авторизован (Unauthorized) |
| 500 | Внутренняя ошибка сервера |

---

## Важные замечания

### Для buyGift:
- Запрос добавляется в очередь и обрабатывается асинхронно
- Обработка может занять до 1 часа
- Подарки в очереди более 24 часов автоматически удаляются
- Подарки в очереди более 1 часа обрабатываются реже
- После добавления в очередь возвращается ID для отслеживания статуса

### Для buyStars:
- Минимальное количество звезд: 50
- Минимаьная комиссия 3% (операционные расходы сервиса)
- Покупка выполняется синхронно

### Для getQueueItemStatus:
- Требует ID подарка из ответа buyGift
- Токен должен соответствовать токену, использованному при создании подарка
- Показывает актуальный статус обработки подарка
- Включает информацию о количестве попыток и времени в очереди
- Безопасность: только владелец токена может получить статус своего подарка

### Общие требования:
- Все токены должны быть валидными и активными
- Баланс токена должен быть достаточным для выполнения операции
- Username получателя должен существовать и быть активным
- ID подарка должен быть получен из ответа buyGift
